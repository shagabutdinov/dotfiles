export PATH=$PATH:/home/leo/.composer/vendor/bin:/usr/lib/jvm/java-8-openjdk/bin/:/home/leo/.gem/ruby/2.3.0/bin:/home/leo/src/go/bin

export BROWSER=firefox
export APPLICATION_ENV=development

export PROMPT="%{$bg[blue]%}%{$fg[white]%}%2~ å†¬%{$reset_color%} "
export GOPATH=~/src/go

export TERM='rxvt-unicode'
export COLORTERM='rxvt-unicode-256color'

autoload -U select-word-style
select-word-style bash

bindkey "\e\e[D" backward-word
bindkey "\e\e[C" forward-word

autoload -U promptinit
promptinit

zle -N prepend-sudo prepend_sudo
function prepend_sudo() {
        if [ "$BUFFER" ]; then
                BUFFER="sudo "$BUFFER
        else
                BUFFER="sudo "$(fc -ln -1)
        fi
        CURSOR=$(($CURSOR+5))
}

function o() {
  nohup xdg-open "$@" > /dev/null 2> /dev/null &
  disown
}

bindkey "^T" prepend-sudo
alias -g G="| grep"

alias yaourt="yaourt --noconfirm"
alias mv=/bin/mv
alias pwgen="pwgen 12"
alias nc="sudo netctl"
alias ag='alias | grep -A 2 -B 2'
alias cds='cd ~/src/'

alias s="subl3"
alias b="bundle exec"
alias x="xsel -ib"
alias l="ls --color -hl --group-directories-first"
alias ls="ls --color -h --group-directories-first"

alias pm="sudo pacman"
alias pms="sudo pacman -S"
alias pmr="sudo pacman -R"
alias pmro="sudo pacman -Rns \$(pacman -Qtdq)"
alias pmq="pacman -Ql"

alias sc="sudo systemctl"
alias scs="sudo systemctl start"
alias scr="sudo systemctl restart"
alias sct="sudo systemctl stop"

alias dfp="balmora dotfiles-submit"
alias dfu="balmora dotfiles-update"

export GREP_OPTIONS=''
export NODE_PATH="~/.node:/usr/lib/node_modules"
export WINEARCH='win32'

alias grep="grep --exclude-dir=.cvs --exclude-dir=.git --exclude-dir=.hg --exclude-dir=.svn --color=auto"
alias tree="tree --dirsfirst"
alias ps="ps -xau"
alias cal="cal -3m"
alias uwhatsapp="chromium --app=https://web.whatsapp.com"

alias wd="nmcli -p dev wifi list"
alias wc="nmcli -p dev wifi connect"
alias wl="nmcli -p con show"
alias ws="nmcli -p con show --active"
alias wu="nmcli -p con up id"

alias d="docker"
alias de="docker exec -i -t"
alias di="docker inspect"
alias dp='docker ps --format "table{{.ID}}\t{{.Names}}\t{{.Image}}\t{{.Status}}"'
alias dr="docker run --rm -i -t"
alias dl="docker logs --tail 200"
alias dlf="docker logs --follow"
alias da="docker attach --no-stdin"

alias c="docker-compose -f"
alias cm='docker-compose -f config/local/main.yml'
alias cl='docker-compose -f config/$(ls --color=none config/ | grep --color=none \\.local)/main.yml'
alias ct='docker-compose -f config/$(ls --color=none config/ | grep --color=none \\.local)/test.yml'
# alias cd='docker-compose -f config/$(ls --color=none config/ | grep --color=none \\.dev1\\.idfly\\.ru)/main.yml'

alias co='sudo chown -R leo: '
alias cc='sudo chown -R leo: .'

alias gs="git show --color"
alias gsp="git commit -v -a && git push"
alias gsa="git commit -v -a --amend && git push --force"
alias gpf="git push --force"
alias ge="git rebase"
alias gei="git rebase --interactive"
alias gec="git rebase --continue"
alias gea="git rebase --abort"
alias gpu='git push -u origin $(current_branch)'
alias gdd='git diff --color | diff-so-fancy | less'
alias gdc='git diff --cached'
alias gh='git stash'
alias ghp='git stash pop'
alias gfp='git fetch --prune'
alias gcb='git checkout origin/dev'
alias gcm='git checkout origin/master'
alias gt='git reset'


alias json='python -m "json.tool"'

function find-docker-container() {
  echo $(
    docker ps --format "table{{.ID}}\t{{.Names}}\t{{.Image}}\t{{.Status}}" |
    grep $1 |
    grep $2 $3 |
    sort -k 2 |
    head -n 1 |
    awk "{ print \$1 }"
  )
}

alias dbe='docker exec -i -t $(find-docker-container backend -v admin)'
alias dbea='docker exec -i -t $(find-docker-container backend admin)'
alias dte='docker exec -i -t $(find-docker-container _test backend)'
alias dfe='docker exec -i -t $(find-docker-container frontend -v admin)'
alias dfea='docker exec -i -t $(find-docker-container frontend admin)'

alias isd="issue -S --from origin/dev --id "
alias ism="issue -S --from origin/master --id "

alias xe=' \
  docker exec -i -t $(find-docker-container backend -v admin) \
'

alias xc='
  docker exec -i -t $(find-docker-container backend -v admin) \
    rails console \
'

alias xr='
  docker exec -i -t $(find-docker-container backend -v admin) \
    rails runner \
'

alias xg='
  docker exec -i -t $(find-docker-container backend -v admin) \
    rails generate \
'


alias xm='
  docker exec -i -t $(find-docker-container backend -v admin) \
    rake db:migrate \
'

alias xms='
  docker exec -i -t $(find-docker-container backend -v admin) \
    rake db:migrate:status \
'

alias xmr='
  docker exec -i -t $(find-docker-container backend -v admin) \
    rake db:migrate:redo \
'

alias xs='
  docker exec -i -t $(find-docker-container backend -v admin) \
    rake db:seed \
'

alias xdr='
  docker exec -i -t $(find-docker-container backend -v admin) \
    rake db:rollback \
'

alias xbi='
  docker exec -i -t $(find-docker-container backend -v admin) \
    bundle install --jobs 8 --path vendor/bundle --full-index \
'

alias xd='docker exec -i -t $(find-docker-container postgres -v admin) \
  psql -P pager -U postgres database \
'

alias ze=' \
  docker exec -i -t $(find-docker-container _test -v admin) \
'

alias zc='
  docker exec -i -t $(find-docker-container _test -v admin) \
    rails console \
'

alias zr='
  docker exec -i -t $(find-docker-container _test -v admin) \
    rails runner \
'

alias zg='
  docker exec -i -t $(find-docker-container _test -v admin) \
    rails generate \
'

alias zm='
  docker exec -i -t $(find-docker-container _test -v admin) \
    rake db:migrate \
'

alias zms='
  docker exec -i -t $(find-docker-container _test -v admin) \
    rake db:migrate:status \
'

alias zmr='
  docker exec -i -t $(find-docker-container _test -v admin) \
    rake db:migrate:redo \
'

alias zs='
  docker exec -i -t $(find-docker-container _test -v admin) \
    rake db:seed \
'

alias zdr='
  docker exec -i -t $(find-docker-container _test -v admin) \
    rake db:rollback \
'

alias zbi='
  docker exec -i -t $(find-docker-container _test -v admin) \
    bundle install --jobs 8 --path vendor/bundle --full-index \
'

alias zd='docker exec -i -t $(find-docker-container postgres -v admin) \
  psql -P pager -U postgres test \
'

function docker-backend-path() {
  docker inspect $(find-docker-container backend -v admin) |
    grep -o '/.*:/app:rw' | sed -E "s/:.*//"
}

function xgm {
  MIGRATION=$(
    docker exec -i -t $(find-docker-container backend -v admin) rails generate migration $@ |
      grep -o 'db/.*.rb' |
      head -n 1
  )

  docker exec -i -t $(find-docker-container backend -v admin) chown 1000:1000 $MIGRATION
  subl3 $(docker-backend-path)/$MIGRATION
}

alias xp='cd $(docker-backend-path)'

umask 002

eval "$(ssh-agent -s)" > /dev/null 2>&1
ssh-add > /dev/null 2>&1

function deploy-celluloidheaven-to-staging {
  docker exec -i -t $(find-docker-container _test -v admin) rspec
  if [ $? -ne 0 ]; then
    echo "\033[0;31mBUILD FAILED\033[0m"
    return 1
  fi

  git push
  if [ $? -ne 0 ]; then
    echo "\033[0;31mPUSH FAILED\033[0m"
    return 1
  fi

  bundle exec cap staging deploy
  if [ $? -ne 0 ]; then
    echo "\033[0;31mDEPLOY FAILED\033[0m"
    return 1
  fi

  return 0
}

function download-celluloidheaven-data {
  cd $(docker-backend-path)

  docker stop $(find-docker-container backend -v admin)

  docker exec -i $(find-docker-container postgres -v admin) psql -U postgres \
    -c 'DROP DATABASE "database"'

  if [ $? -ne 0 ]; then
    echo "\033[0;31mDOWNLOAD FAILED\033[0m"
    return 1
  fi

  ssh ubuntu@staging.celluloidheaven.net "pg_dumpall | gzip" |
    gunzip |
    docker exec -i $(find-docker-container postgres -v admin) psql -U postgres

  if [ $? -ne 0 ]; then
    echo "\033[0;31mDOWNLOAD FAILED\033[0m"
    return 1
  fi

  docker exec -i $(find-docker-container postgres -v admin) psql -U postgres \
    -c 'ALTER DATABASE "diagonal_production" RENAME TO "database"'

  if [ $? -ne 0 ]; then
    echo "\033[0;31mDOWNLOAD FAILED\033[0m"
    return 1
  fi

  docker-compose -f config/celluloidheaven.local/main.yml stop
  docker-compose -f config/celluloidheaven.local/main.yml up -d

  return 0
}
